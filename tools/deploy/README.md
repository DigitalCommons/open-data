# Installing the Data Factory (the se_open_data service)

Here we are assuming the server has been deployed on a Debian-derived
Linux server, using the `sea-map-server.yml` Ansible playbook, and
that the application is being deployed to a user for the purpose
called `carrot`.

## generate an `initial.env`

Put the file somewhere the `carrot` user can access, containing the
variables as in [example.env], suich as in the user's home
directory. Of course you will need to fill in the redacted passwords
with the real ones. You may also choose to alter or add to the
configuration.

## Run the deploy script

```
su - carrot                    # or whichever user will host this project
set -a; . initial.env; set +a  # update appropriately for the path to initial.env

# $SEOD_GIT_BRANCH should be set now, so the deploy script can be downloaded thus:
wget https://raw.github.com/DigitalCommons/open-data/$SEOD_GIT_BRANCH/tools/deploy/deploy.sh

# Then this will check out the branch $SEOD_GIT_BRANCH of the code in $SEOD_WORKING_DIR
# It will install and start a systemd service to run the data factory for this user
bash deploy.sh
```

## Check this is running ok

As the user (`carrot`), run:

    systemctl --user status se_open_data

The status should show the service is enabled and has run (or is running) without errors.

To get the logs, use this:

    journalctl --user -u se_open_data

There should be no errors listed.

Look in `~carrot/public_html/`, you should see the data generated by
the service (when it has completed at least once).

Check the graphs listed on
`http://$hostname:8890/conductor/graphs_page.vspx?page=1&sid=5cd266107992797a799ce9793cfd70cc&realm=virtuoso_admin`.
Where `$hostname` is the domain of the host running the Virtuoso
triple-store database to which the service deploys to (normally the
same host).  There should be the graphs you expect for the datasets
deployed by the service.

## Add a `custom.conf` for the Apache virtual host

You need to deploy (as root) an apache config like this
one (adapted as necessary) under
`/var/www/vhosts/$domain/custom.conf`, where $domain is the virtual
host's domain that will be used.

[example.env]: ./example.env
